# SQL Server SSLæª¢æŸ¥ - é™¤éŒ¯æ­¥é©Ÿèˆ‡çµæœåˆ¤è®€

## ğŸš€ ç¬¬ä¸€æ­¥ï¼šåŠ å…¥æª¢æŸ¥ç¨‹å¼ç¢¼

### 1. åœ¨æ‚¨çš„Formä¸­åŠ å…¥ä¸€å€‹æ¸¬è©¦æŒ‰éˆ•

```csharp
private void btnTestSsl_Click(object sender, EventArgs e)
{
    SqlServerSslChecker.ShowSslCheckDialog();
}
```

### 2. æˆ–è€…ç›´æ¥åœ¨ç¾æœ‰æŒ‰éˆ•ä¸­åŠ å…¥å¿«é€Ÿæª¢æŸ¥

```csharp
private void button2_Click_1(object sender, EventArgs e)
{
    // åœ¨åŸæœ¬ç¨‹å¼ç¢¼å‰é¢åŠ å…¥é€™æ®µ
    bool sslSupported = QuickSslCheck();
    MessageBox.Show($"SSLæ”¯æ´ç‹€æ³: {(sslSupported ? "æ”¯æ´" : "ä¸æ”¯æ´")}", "æª¢æŸ¥çµæœ");
    
    // ... åŸæœ¬çš„ç¨‹å¼ç¢¼
}
```

## ğŸ”§ ç¬¬äºŒæ­¥ï¼šé€²è¡Œé™¤éŒ¯

### æ–¹æ³•1ï¼šä½¿ç”¨æª¢æŸ¥å°è©±æ¡†

1. **æŒ‰ä¸‹æª¢æŸ¥æŒ‰éˆ•**
1. **åœ¨å½ˆå‡ºçš„å°è©±æ¡†ä¸­é»æ“Šã€Œé–‹å§‹æª¢æŸ¥ã€**
1. **ç­‰å¾…2-10ç§’çœ‹çµæœ**

### æ–¹æ³•2ï¼šæŸ¥çœ‹Consoleè¼¸å‡º

1. **åœ¨Visual Studioä¸­æŒ‰F5é–‹å§‹é™¤éŒ¯**
1. **åŸ·è¡Œæª¢æŸ¥åŠŸèƒ½**
1. **åœ¨Visual Studioçš„ã€Œè¼¸å‡ºã€è¦–çª—æŸ¥çœ‹Consoleè¨Šæ¯**
- é¸æ“‡ï¼šæª¢è¦– â†’ è¼¸å‡º â†’ é¡¯ç¤ºè¼¸å‡ºä¾†æºï¼šä¸€èˆ¬

### æ–¹æ³•3ï¼šåŠ å…¥MessageBoxé¡¯ç¤º

```csharp
private async void btnTest_Click(object sender, EventArgs e)
{
    var result = await SqlServerSslChecker.CheckSqlServerSslSupport();
    
    string message = $@"
=== SSLæª¢æŸ¥çµæœ ===
åŸºæœ¬é€£ç·š: {(result.BasicConnection ? "âœ“æˆåŠŸ" : "âœ—å¤±æ•—")}
SSLæ”¯æ´: {(result.SslSupported ? "âœ“æ”¯æ´" : "âœ—ä¸æ”¯æ´")}
æ†‘è­‰æœ‰æ•ˆ: {(result.CertificateValid ? "âœ“æœ‰æ•ˆ" : "âœ—ç„¡æ•ˆ")}

å»ºè­°è¨­å®š:
Encrypt = {result.RecommendedSettings?.Encrypt}
TrustServerCertificate = {result.RecommendedSettings?.TrustServerCertificate}

èªªæ˜: {result.RecommendedSettings?.Reason}
";
    
    MessageBox.Show(message, "SSLæª¢æŸ¥çµæœ", MessageBoxButtons.OK, MessageBoxIcon.Information);
}
```

## ğŸ“Š ç¬¬ä¸‰æ­¥ï¼šçµæœåˆ¤è®€

### ğŸŸ¢ ç†æƒ³çµæœï¼ˆæœ€å®‰å…¨ï¼‰

```
=== SQL Server SSL æ”¯æ´æª¢æŸ¥ ===
ä¼ºæœå™¨ï¼šHilife-tfs
è³‡æ–™åº«ï¼šHI_TMMAIN

1. åŸºæœ¬é€£ç·š: âœ“ æˆåŠŸ
2. SSLæ”¯æ´: âœ“ æ”¯æ´
3. æ†‘è­‰é©—è­‰: âœ“ æœ‰æ•ˆæ†‘è­‰
4. SSLè©³ç´°è³‡è¨Š:
   åŠ å¯†æ¼”ç®—æ³•: TRUE
   æ†‘è­‰ä¸»é«”: CN=Hilife-tfs
   æ†‘è­‰ç™¼è¡Œè€…: CN=YourCA
5. æ•ˆèƒ½æ¸¬è©¦:
   ç„¡SSLé€£ç·šæ™‚é–“: 45ms
   SSLé€£ç·šæ™‚é–“: 52ms
   æ•ˆèƒ½å½±éŸ¿: +15.6%
6. å»ºè­°è¨­å®š:
   Encrypt: True
   TrustServerCertificate: False
```

**âœ… é€™ç¨®æƒ…æ³ä¸‹çš„ä¿®å¾©ç¨‹å¼ç¢¼ï¼š**

```csharp
builder.Encrypt = true;
builder.TrustServerCertificate = false;  // åš´æ ¼é©—è­‰æ†‘è­‰
```

### ğŸŸ¡ å¸¸è¦‹çµæœï¼ˆå¯æ¥å—ï¼‰

```
=== SQL Server SSL æ”¯æ´æª¢æŸ¥ ===
ä¼ºæœå™¨ï¼šHilife-tfs
è³‡æ–™åº«ï¼šHI_TMMAIN

1. åŸºæœ¬é€£ç·š: âœ“ æˆåŠŸ
2. SSLæ”¯æ´: âœ“ æ”¯æ´
3. æ†‘è­‰é©—è­‰: âœ— ç„¡æ•ˆ/è‡ªç°½æ†‘è­‰
4. SSLè©³ç´°è³‡è¨Š:
   åŠ å¯†æ¼”ç®—æ³•: TRUE
   æ†‘è­‰ä¸»é«”: CN=Hilife-tfs
   æ†‘è­‰ç™¼è¡Œè€…: CN=Hilife-tfs  â† è‡ªç°½æ†‘è­‰
5. æ•ˆèƒ½æ¸¬è©¦:
   ç„¡SSLé€£ç·šæ™‚é–“: 45ms
   SSLé€£ç·šæ™‚é–“: 58ms
   æ•ˆèƒ½å½±éŸ¿: +28.9%
6. å»ºè­°è¨­å®š:
   Encrypt: True
   TrustServerCertificate: True
```

**âœ… é€™ç¨®æƒ…æ³ä¸‹çš„ä¿®å¾©ç¨‹å¼ç¢¼ï¼š**

```csharp
builder.Encrypt = true;
builder.TrustServerCertificate = true;  // ä¿¡ä»»è‡ªç°½æ†‘è­‰
```

### ğŸ”´ å•é¡Œçµæœï¼ˆéœ€è¦è™•ç†ï¼‰

```
=== SQL Server SSL æ”¯æ´æª¢æŸ¥ ===
ä¼ºæœå™¨ï¼šHilife-tfs
è³‡æ–™åº«ï¼šHI_TMMAIN

1. åŸºæœ¬é€£ç·š: âœ“ æˆåŠŸ
2. SSLæ”¯æ´: âœ— ä¸æ”¯æ´
   SSLé€£ç·šéŒ¯èª¤ï¼ˆä¿¡ä»»æ†‘è­‰ï¼‰ï¼šA connection was attempted while a previous...
3. æ†‘è­‰é©—è­‰: âœ— ç„¡æ•ˆ/è‡ªç°½æ†‘è­‰
6. å»ºè­°è¨­å®š:
   Encrypt: False
   TrustServerCertificate: False
```

**âš ï¸ é€™ç¨®æƒ…æ³ä¸‹çš„è™•ç†æ–¹å¼ï¼š**

```csharp
// æš«æ™‚ä¿æŒåŸç‹€ï¼Œä½†è¨˜éŒ„è­¦å‘Š
builder.Encrypt = false;  // å…ˆä¸å•Ÿç”¨SSL
// ä¸¦è¯çµ¡ITäººå“¡å‡ç´šSQL Serveræˆ–å•Ÿç”¨SSL
```

## ğŸ” ç¬¬å››æ­¥ï¼šå¸¸è¦‹éŒ¯èª¤èˆ‡è§£æ±º

### éŒ¯èª¤1ï¼šé€£ç·šé€¾æ™‚

```
åŸºæœ¬é€£ç·šéŒ¯èª¤ï¼šTimeout expired. The timeout period elapsed...
```

**è§£æ±ºï¼š** æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–å¢åŠ é€¾æ™‚æ™‚é–“

### éŒ¯èª¤2ï¼šæ‰¾ä¸åˆ°ä¼ºæœå™¨

```
åŸºæœ¬é€£ç·šéŒ¯èª¤ï¼šA network-related or instance-specific error...
```

**è§£æ±ºï¼š** æª¢æŸ¥ä¼ºæœå™¨åç¨±å’Œé€£ç·šå­—ä¸²

### éŒ¯èª¤3ï¼šSSLä¸æ”¯æ´

```
SSLé€£ç·šéŒ¯èª¤ï¼ˆä¿¡ä»»æ†‘è­‰ï¼‰ï¼šSSL Provider: No credentials are available...
```

**è§£æ±ºï¼š** SQL Serveræœªå•Ÿç”¨SSLï¼Œéœ€è¦ç®¡ç†å“¡è¨­å®š

### éŒ¯èª¤4ï¼šæ†‘è­‰å•é¡Œ

```
SSLé€£ç·šéŒ¯èª¤ï¼ˆé©—è­‰æ†‘è­‰ï¼‰ï¼šThe certificate chain was issued by an authority...
```

**è§£æ±ºï¼š** ä½¿ç”¨ `TrustServerCertificate = true`

## ğŸ¯ ç¬¬äº”æ­¥ï¼šæ ¹æ“šçµæœä¿®æ”¹ç¨‹å¼ç¢¼

### æƒ…æ³Aï¼šå®Œå…¨æ”¯æ´SSLï¼ˆæ¨è–¦ï¼‰

```csharp
private static void OpenSqlConnectionTest(SqlConnection connection)
{
    string connectionString = GetConnectionStringTest();
    SqlConnectionStringBuilder builder = new SqlConnectionStringBuilder(connectionString);
    
    builder.Encrypt = true;                    // å•Ÿç”¨SSL
    builder.TrustServerCertificate = false;    // åš´æ ¼é©—è­‰æ†‘è­‰
    builder.ConnectTimeout = 30;
    
    connection.ConnectionString = builder.ConnectionString;
    connection.Open();
}
```

### æƒ…æ³Bï¼šæ”¯æ´SSLä½†æ†‘è­‰ç„¡æ•ˆï¼ˆå¸¸è¦‹ï¼‰

```csharp
private static void OpenSqlConnectionTest(SqlConnection connection)
{
    string connectionString = GetConnectionStringTest();
    SqlConnectionStringBuilder builder = new SqlConnectionStringBuilder(connectionString);
    
    builder.Encrypt = true;                    // å•Ÿç”¨SSL
    builder.TrustServerCertificate = true;     // ä¿¡ä»»è‡ªç°½æ†‘è­‰
    builder.ConnectTimeout = 30;
    
    connection.ConnectionString = builder.ConnectionString;
    connection.Open();
}
```

### æƒ…æ³Cï¼šä¸æ”¯æ´SSLï¼ˆæš«æ™‚æ–¹æ¡ˆï¼‰

```csharp
private static void OpenSqlConnectionTest(SqlConnection connection)
{
    string connectionString = GetConnectionStringTest();
    SqlConnectionStringBuilder builder = new SqlConnectionStringBuilder(connectionString);
    
    // è¨˜éŒ„å®‰å…¨è­¦å‘Š
    System.Diagnostics.EventLog.WriteEntry("Application", 
        "è­¦å‘Šï¼šè³‡æ–™åº«é€£ç·šæœªåŠ å¯†ï¼Œå»ºè­°å•Ÿç”¨SSL", 
        System.Diagnostics.EventLogEntryType.Warning);
    
    builder.Encrypt = false;                   // æš«æ™‚ä¸ä½¿ç”¨SSL
    builder.ConnectTimeout = 30;
    
    connection.ConnectionString = builder.ConnectionString;
    connection.Open();
}
```

## ğŸ“‹ æª¢æŸ¥æ¸…å–®

åŸ·è¡Œå®Œæª¢æŸ¥å¾Œï¼Œè«‹ç¢ºèªï¼š

- [ ] çœ‹åˆ°äº†æª¢æŸ¥çµæœï¼ˆæˆåŠŸ/å¤±æ•—ï¼‰
- [ ] ç¢ºèªSSLæ”¯æ´ç‹€æ³ï¼ˆæ”¯æ´/ä¸æ”¯æ´ï¼‰
- [ ] å–å¾—äº†å»ºè­°è¨­å®šå€¼
- [ ] æ ¹æ“šçµæœé¸æ“‡äº†é©ç•¶çš„ä¿®å¾©æ–¹æ¡ˆ
- [ ] æº–å‚™å¥½è¦ä¿®æ”¹çš„ç¨‹å¼ç¢¼

## ğŸš¨ é‡è¦æé†’

1. **æ¸¬è©¦ç’°å¢ƒçš„çµæœé€šå¸¸é©ç”¨æ–¼æ­£å¼ç’°å¢ƒ**
1. **å¦‚æœä¸æ”¯æ´SSLï¼Œä¸è¦å¼·åˆ¶å•Ÿç”¨**ï¼ˆæœƒå°è‡´é€£ç·šå¤±æ•—ï¼‰
1. **è¨˜éŒ„æª¢æŸ¥çµæœ**ï¼Œä»¥ä¾¿å‘ITäººå“¡å ±å‘Š
1. **å„ªå…ˆè§£æ±ºå¯†ç¢¼ç®¡ç†å•é¡Œ**ï¼ˆç›¸å°å®¹æ˜“ï¼‰
1. **SSLå•é¡Œå¯ä»¥åˆ†éšæ®µè™•ç†**ï¼ˆä¸æ€¥æ–¼ä¸€æ¬¡åˆ°ä½ï¼‰